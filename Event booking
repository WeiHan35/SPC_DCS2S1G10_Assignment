#include <iostream>
#include <vector>
#include <string>
#include <fstream>
#include <limits>

using namespace std;

struct Booking {
    int date;
    int venue;
    int slot;
    string decoTheme;
    int decoCost;
    string vendorOption;
    int vendorCost;
};

void clearInput() {
    cin.clear();
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
}

void displayVenues(const vector<string>& venueNames) {
    cout << "Available Venues:\n";
    for (int i = 0; i < (int)venueNames.size(); i++) {
        cout << i + 1 << ". " << venueNames[i] << endl;
    }
}

void displayTimeSlots(const vector<string>& timeSlots) {
    cout << "Available Time Slots:\n";
    for (int i = 0; i < (int)timeSlots.size(); i++) {
        cout << i + 1 << ". " << timeSlots[i] << endl;
    }
}

void displayDecorationThemes() {
    cout << "Decoration Themes:\n";
    cout << "1. Classic (RM 100)\n";
    cout << "2. Rustic  (RM 150)\n";
    cout << "3. Elegant (RM 200)\n";
}

// Save bookings to file
void saveBookingsToFile(const vector<Booking>& bookings) {
    ofstream outFile("bookings.txt");
    for (const Booking& b : bookings) {
        outFile << b.date << ","
            << b.venue << ","
            << b.slot << ","
            << b.decoTheme << ","
            << b.decoCost << ","
            << b.vendorOption << ","
            << b.vendorCost << "\n";
    }
    outFile.close();
}

// Load bookings from file
void loadBookingsFromFile(vector<Booking>& bookings,
    vector<vector<vector<int>>>& bookingStatus) {
    ifstream inFile("bookings.txt");
    if (!inFile) return;

    Booking b;
    char comma;
    while (inFile >> b.date >> comma >> b.venue >> comma >> b.slot >> comma) {
        getline(inFile, b.decoTheme, ',');
        inFile >> b.decoCost >> comma;
        getline(inFile, b.vendorOption, ',');
        inFile >> b.vendorCost;
        inFile.ignore();

        bookings.push_back(b);
        bookingStatus[b.date][b.venue][b.slot] = 1;
    }
    inFile.close();
}

void makeBooking(vector<Booking>& bookings,
    vector<vector<vector<int>>>& bookingStatus,
    const vector<string>& venueNames,
    const vector<string>& timeSlots,
    int MAX_DATES) {
    int date, venue, slot;
    int themeChoice, vendorChoice;
    Booking newBooking;

    // Date validation
    do {
        cout << "Enter booking date (1-" << MAX_DATES << "): ";
        cin >> date;
        if (cin.fail() || date < 1 || date > MAX_DATES) {
            cout << "Invalid date! Please enter 1-" << MAX_DATES << ".\n";
            clearInput();
            continue;
        }
        break;
    } while (true);

    // Venue validation
    displayVenues(venueNames);
    do {
        cout << "Select venue (1-" << venueNames.size() << "): ";
        cin >> venue;
        if (cin.fail() || venue < 1 || venue >(int)venueNames.size()) {
            cout << "Invalid venue! Please enter between 1 and " << venueNames.size() << ".\n";
            clearInput();
            continue;
        }
        venue--;
        break;
    } while (true);

    // Slot validation
    displayTimeSlots(timeSlots);
    do {
        cout << "Select time slot (1-" << timeSlots.size() << "): ";
        cin >> slot;
        if (cin.fail() || slot < 1 || slot >(int)timeSlots.size()) {
            cout << "Invalid slot! Please enter between 1 and " << timeSlots.size() << ".\n";
            clearInput();
            continue;
        }
        slot--;
        break;
    } while (true);

    if (bookingStatus[date][venue][slot] == 1) {
        cout << "I am sorry! This venue is already booked for this date and time slot.\n";
        return;
    }

    newBooking.date = date;
    newBooking.venue = venue;
    newBooking.slot = slot;

    // Decoration validation
    displayDecorationThemes();
    do {
        cout << "Choose table decoration theme (1-3): ";
        cin >> themeChoice;
        if (cin.fail() || themeChoice < 1 || themeChoice > 3) {
            cout << "Invalid theme choice!\n";
            clearInput();
            continue;
        }
        break;
    } while (true);

    switch (themeChoice) {
    case 1: newBooking.decoTheme = "Classic"; newBooking.decoCost = 100; break;
    case 2: newBooking.decoTheme = "Rustic"; newBooking.decoCost = 150; break;
    case 3: newBooking.decoTheme = "Elegant"; newBooking.decoCost = 200; break;
    }

    // Vendor validation
    do {
        cout << "Vendor Options:\n";
        cout << "1. Self-arranged (RM 0)\n";
        cout << "2. Organizer-arranged (RM 300)\n";
        cout << "Select vendor option (1-2): ";
        cin >> vendorChoice;
        if (cin.fail() || (vendorChoice != 1 && vendorChoice != 2)) {
            cout << "Invalid vendor choice!\n";
            clearInput();
            continue;
        }
        break;
    } while (true);

    if (vendorChoice == 1) {
        newBooking.vendorOption = "Self-arranged";
        newBooking.vendorCost = 0;
    }
    else {
        newBooking.vendorOption = "Organizer-arranged";
        newBooking.vendorCost = 300;
    }

    // Mark as booked
    bookingStatus[date][venue][slot] = 1;

    // Save to vector
    bookings.push_back(newBooking);

    // Save immediately to file
    saveBookingsToFile(bookings);

    // Show summary
    cout << "\nBooking Confirmed!\n";
    cout << "Date: " << date
        << "\nVenue: " << venueNames[venue]
        << "\nTime Slot: " << timeSlots[slot]
        << "\nDecoration: " << newBooking.decoTheme << " (RM " << newBooking.decoCost << ")"
        << "\nVendor: " << newBooking.vendorOption << " (RM " << newBooking.vendorCost << ")"
        << "\nTotal Cost: RM " << (newBooking.decoCost + newBooking.vendorCost) << "\n";
}

void showAllBookings(const vector<Booking>& bookings,
    const vector<string>& venueNames,
    const vector<string>& timeSlots) {
    if (bookings.empty()) {
        cout << "\nNo bookings yet.\n";
        return;
    }
    cout << "\nAll Bookings:\n";
    for (const Booking& b : bookings) {
        cout << "Date: " << b.date
            << ", Venue: " << venueNames[b.venue]
            << ", Time: " << timeSlots[b.slot]
            << ", Deco: " << b.decoTheme
            << ", Vendor: " << b.vendorOption
            << ", Total: RM " << (b.decoCost + b.vendorCost)
            << "\n";
    }
}

int main() {
    const int MAX_DATES = 31;
    const int MAX_VENUES = 5;
    const int MAX_SLOTS = 3;

    vector<string> timeSlots = { "12pm-3pm", "4pm-7pm", "8pm-11pm" };
    vector<string> venueNames = { "Hall A", "Hall B", "Hall C", "Outdoor", "VIP Lounge" };

    // bookingStatus[date][venue][slot]
    vector<vector<vector<int>>> bookingStatus(MAX_DATES + 1,
        vector<vector<int>>(MAX_VENUES, vector<int>(MAX_SLOTS, 0)));

    vector<Booking> bookings;

    loadBookingsFromFile(bookings, bookingStatus);

    int choice;
    do {
        cout << "\n==== Event Booking & Logistics System ====\n";
        cout << "1. Make a Booking\n";
        cout << "2. View All Bookings\n";
        cout << "0. Exit\n";
        cout << "Enter your choice: ";
        cin >> choice;

        if (cin.fail()) {
            cout << "Invalid input! Please enter a number.\n";
            clearInput();
            continue;
        }

        switch (choice) {
        case 1:
            makeBooking(bookings, bookingStatus, venueNames, timeSlots, MAX_DATES);
            break;
        case 2:
            showAllBookings(bookings, venueNames, timeSlots);
            break;
        case 0:
            cout << "Goodbye!\n";
            break;
        default:
            cout << "Invalid choice.\n";
        }

    } while (choice != 0);

    return 0;
}
